{% extends "layout.html" %} {% set title = 'users_books Admin' %} {% set page =
'users_books_admin' %} {% set bodyClass = bodyClass|default('') %} {% set
instance = instance|default(title) %}
{% block header %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('_app_templates.static', filename='ebookslv_admin.css') }}" />
{% endblock %}
{% block body %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">
      users_books Allow‑List Management
      <small class="text-muted ub-small-heading">(Admin)</small>
    </h3>
  <!-- Hidden CSRF token (explicitly provided by route as ub_csrf_token) -->
  <input type="hidden" id="ub-csrf" name="csrf_token" value="{{ ub_csrf_token|default('') }}" />
  </div>
  <div class="panel-body">
  <p class="text-muted ub-panel-note">
      Create and view allow‑list mappings between Calibre users and books. 1)
      Select one or more users (left) and books (middle) 2) Click "Add Selected
      Mappings". The bottom table lists all existing mappings (email → book
      title) with delete actions.
    </p>

  <div class="row ub-row-gap">
      <!-- Users -->
      <div class="col-sm-4">
        <fieldset class="ub-fieldset">
          <legend class="ub-section-legend ub-legend">Users (Non‑Admin)</legend>
          <input
            id="ub-filter-users"
            class="form-control input-sm ub-filter"
            type="text"
            placeholder="Filter by email or name"
          />
          <div id="ub-users-box"></div>
          <div class="ub-flex ub-box-gap">
            <button
              id="ub-users-reload"
              class="btn btn-default btn-xs"
              type="button"
            >
              <span class="glyphicon glyphicon-refresh"></span> Reload
            </button>
            <button
              id="ub-users-select-all"
              class="btn btn-default btn-xs"
              type="button"
            >
              Select All
            </button>
            <button
              id="ub-users-clear"
              class="btn btn-default btn-xs"
              type="button"
            >
              Clear
            </button>
          </div>
          <div class="text-muted ub-box-gap ub-micro">
            Source: /admin/users_books/all_users (excludes admin accounts).
          </div>
        </fieldset>
      </div>

      <!-- Books -->
      <div class="col-sm-4">
        <fieldset class="ub-fieldset">
          <legend class="ub-section-legend ub-legend">Books</legend>
          <input
            id="ub-filter-books"
            class="form-control input-sm ub-filter"
            type="text"
            placeholder="Filter by title or id"
          />
          <div id="ub-books-box"></div>
          <div class="ub-flex ub-box-gap">
            <button
              id="ub-books-reload"
              class="btn btn-default btn-xs"
              type="button"
            >
              <span class="glyphicon glyphicon-refresh"></span> Reload
            </button>
            <button
              id="ub-books-select-all"
              class="btn btn-default btn-xs"
              type="button"
            >
              Select All
            </button>
            <button
              id="ub-books-clear"
              class="btn btn-default btn-xs"
              type="button"
            >
              Clear
            </button>
          </div>
          <div class="text-muted ub-box-gap ub-micro">
            Source: /admin/users_books/all_books (full library; consider
            pagination if large).
          </div>
        </fieldset>
      </div>

      <!-- Actions -->
      <div class="col-sm-4">
        <fieldset class="ub-fieldset">
          <legend class="ub-section-legend ub-legend">Actions</legend>
          <div class="ub-flex ub-flex-col">
            <button
              id="ub-add-mappings"
              class="btn btn-success btn-sm"
              type="button"
            >
              <span class="glyphicon glyphicon-plus"></span> Add Selected
              Mappings
            </button>
            <button
              id="ub-reload-mappings"
              class="btn btn-primary btn-sm"
              type="button"
            >
              <span class="glyphicon glyphicon-eye-open"></span> Refresh Mapping
              List
            </button>
            <button
              id="ub-clear-selection"
              class="btn btn-default btn-sm"
              type="button"
            >
              Clear All Selections
            </button>
          </div>
          <hr class="ub-hr-tight" />
          <p class="help-block ub-help-margin">Selections</p>
          <ul class="ub-selections-ul">
            <li><span id="ub-count-users">0</span> user(s)</li>
            <li><span id="ub-count-books">0</span> book(s)</li>
          </ul>
          <hr class="ub-hr-tight" />
          <p class="text-muted ub-micro-tight">
            Each (user, book) pair triggers an individual POST. For large
            batches consider a future bulk endpoint.
          </p>
        </fieldset>
      </div>
    </div>

    <!-- Mappings Table -->
    <h4 class="ub-h4">Existing Mappings</h4>
    <div class="table-responsive ub-table-gap">
  <table id="ub-mappings-table" class="table table-condensed table-striped ub-margin-b-8">
        <thead>
          <tr class="ub-sticky-top">
            <th class="ub-w-email">User Email</th>
            <th class="ub-w-userid">User ID</th>
            <th>Book Title</th>
            <th class="ub-w-bookid">Book ID</th>
            <th class="ub-w-del">Delete</th>
          </tr>
        </thead>
        <tbody id="ub-mappings-tbody"></tbody>
      </table>
    </div>
  <div class="text-muted ub-mappings-note">
      Source: /admin/users_books/mappings_full&nbsp; (<span
        id="ub-mappings-total"
        >0</span
      >
      total)
    </div>

  </div>
</div>

<script>
  (function () {
    "use strict";
    const usersBox = document.getElementById("ub-users-box");
    const booksBox = document.getElementById("ub-books-box");
    const filterUsers = document.getElementById("ub-filter-users");
    const filterBooks = document.getElementById("ub-filter-books");
    const btnUsersReload = document.getElementById("ub-users-reload");
    const btnUsersSelectAll = document.getElementById("ub-users-select-all");
    const btnUsersClear = document.getElementById("ub-users-clear");
    const btnBooksReload = document.getElementById("ub-books-reload");
    const btnBooksSelectAll = document.getElementById("ub-books-select-all");
    const btnBooksClear = document.getElementById("ub-books-clear");
    const btnAddMappings = document.getElementById("ub-add-mappings");
    const btnReloadMappings = document.getElementById("ub-reload-mappings");
    const btnClearSelection = document.getElementById("ub-clear-selection");
    const mappingsTbody = document.getElementById("ub-mappings-tbody");
    const mappingsTotalSpan = document.getElementById("ub-mappings-total");
    const countUsersSpan = document.getElementById("ub-count-users");
    const countBooksSpan = document.getElementById("ub-count-books");
    const csrfInput = document.getElementById("ub-csrf");

    function csrfToken() { // (B) explicit accessor with defensive empty string
      if (!csrfInput) return "";
      return csrfInput.value || "";
    }

    function setBusy(disabled) {
      [
        btnUsersReload,
        btnUsersSelectAll,
        btnUsersClear,
        btnBooksReload,
        btnBooksSelectAll,
        btnBooksClear,
        btnAddMappings,
        btnReloadMappings,
        btnClearSelection,
      ].forEach((b) => {
        if (b) b.disabled = disabled;
      });
    }
    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error("HTTP " + r.status + " " + url);
      return r.json();
    }
    function renderUserList(users) {
      usersBox.innerHTML = "";
      if (!users.length) {
        usersBox.innerHTML =
          '<div class="text-muted" style="font-size:11px;">No users.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      users.forEach((u) => {
        const email = (u.email || "").trim();
        const name = (u.name || "").trim();
        const display = email || name || "User " + u.user_id;
        const label = document.createElement("label");
        label.innerHTML =
          '<input type="checkbox" value="' +
          u.user_id +
          '" data-email="' +
          display.replace(/"/g, "&quot;") +
          '"> <span class="ub-nowrap">' +
          (email
            ? "<strong>" + escapeHtml(email) + "</strong>"
            : "<strong>(no email)</strong>") +
          ' <span class="ub-small">#' +
          u.user_id +
          "</span>" +
          (name && name !== email
            ? ' <span class="text-muted" style="font-size:10px;">(' +
              escapeHtml(name) +
              ")</span>"
            : "") +
          "</span>";
        frag.appendChild(label);
      });
      usersBox.appendChild(frag);
      applyUserFilter();
      updateSelectionCounts();
    }
    function renderBookList(books) {
      booksBox.innerHTML = "";
      if (!books.length) {
        booksBox.innerHTML =
          '<div class="text-muted" style="font-size:11px;">No books.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      books.forEach((b) => {
        const title = b.title || "(Untitled)";
        const label = document.createElement("label");
        label.innerHTML =
          '<input type="checkbox" value="' +
          b.book_id +
          '" data-title="' +
          title.replace(/"/g, "&quot;") +
          '"> <span class="ub-nowrap"><strong>' +
          escapeHtml(title) +
          '</strong> <span class="ub-small">#' +
          b.book_id +
          "</span></span>";
        frag.appendChild(label);
      });
      booksBox.appendChild(frag);
      applyBookFilter();
      updateSelectionCounts();
    }
    function applyUserFilter() {
      const term = filterUsers.value.trim().toLowerCase();
      Array.from(usersBox.querySelectorAll("label")).forEach((l) => {
        const t = l.textContent.toLowerCase();
        l.style.display = term && t.indexOf(term) === -1 ? "none" : "";
      });
    }
    function applyBookFilter() {
      const term = filterBooks.value.trim().toLowerCase();
      Array.from(booksBox.querySelectorAll("label")).forEach((l) => {
        const t = l.textContent.toLowerCase();
        l.style.display = term && t.indexOf(term) === -1 ? "none" : "";
      });
    }
    filterUsers.addEventListener("input", applyUserFilter);
    filterBooks.addEventListener("input", applyBookFilter);
    function selectedValues(container) {
      return Array.from(
        container.querySelectorAll('input[type="checkbox"]:checked')
      )
        .map((cb) => Number(cb.value))
        .filter((n) => Number.isInteger(n) && n > 0);
    }
    function updateSelectionCounts() {
      countUsersSpan.textContent = selectedValues(usersBox).length;
      countBooksSpan.textContent = selectedValues(booksBox).length;
    }
    usersBox.addEventListener("change", updateSelectionCounts);
    booksBox.addEventListener("change", updateSelectionCounts);
    async function loadUsers() {
      console.log("Loading all non-admin users...");
      try {
        const data = await fetchJSON("/admin/users_books/all_users");
        renderUserList(data.users || []);
        console.log("Users loaded:", (data.count || 0));
      } catch (e) {
        console.error("Error loading users:", e);
      }
    }
    async function loadBooks() {
      console.log("Loading all books...");
      try {
        const data = await fetchJSON("/admin/users_books/all_books");
        renderBookList(data.books || []);
        console.log("Books loaded:", (data.count || 0));
      } catch (e) {
        console.error("Error loading books:", e);
      }
    }
    async function loadMappings() {
      console.log("Loading mappings...");
      setBusy(true);
      try {
        const data = await fetchJSON("/admin/users_books/mappings_full");
        renderMappings(data.mappings || []);
        console.log("Mappings loaded:", (data.count || 0));
      } catch (e) {
        console.error("Error loading mappings:", e);
      } finally {
        setBusy(false);
      }
    }
    function renderMappings(rows) {
      mappingsTbody.innerHTML = "";
      mappingsTotalSpan.textContent = rows.length;
      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "text-muted";
        td.textContent = "No mappings present.";
        tr.appendChild(td);
        mappingsTbody.appendChild(tr);
        return;
      }
      const frag = document.createDocumentFragment();
      rows.forEach((r) => {
        const tr = document.createElement("tr");
        const email = r.email || "";
        const title = r.title || "(Untitled)";
        tr.innerHTML =
          "<td>" +
          escapeHtml(email) +
          "</td><td>" +
          r.user_id +
          "</td><td>" +
          escapeHtml(title) +
          "</td><td>" +
          r.book_id +
          '</td><td><button type="button" class="btn btn-xs btn-danger" data-del="' +
          r.user_id +
          ":" +
          r.book_id +
          '" title="Delete mapping"><span class="glyphicon glyphicon-remove"></span></button></td>';
        frag.appendChild(tr);
      });
      mappingsTbody.appendChild(frag);
    }
    mappingsTbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const parts = btn.getAttribute("data-del").split(":");
      const uid = Number(parts[0]);
      const bid = Number(parts[1]);
      if (!confirm("Delete mapping?\nUser: " + uid + "\nBook: " + bid)) return;
      console.log("Deleting mapping user=", uid, " book=", bid, "...");
      setBusy(true);
      try {
        const headers = {};
        const tok = csrfToken();
        if (tok) headers["X-CSRFToken"] = tok; // (C) only attach if present
        const r = await fetch(
          "/admin/users_books/mappings_full/" + uid + "/" + bid,
          {
            method: "DELETE",
            headers,
            credentials: "same-origin",
          }
        );
        if (!r.ok) {
          console.error("Delete failed HTTP", r.status);
        } else {
          const data = await r.json();
          console.log("Delete status:", data.status);
        }
        await loadMappings();
      } catch (e2) {
        console.error("Error deleting mapping:", e2);
      } finally {
        setBusy(false);
      }
    });
    async function addMappings() {
      const userIds = selectedValues(usersBox);
      const bookIds = selectedValues(booksBox);
      if (!userIds.length || !bookIds.length) {
        console.warn("Select at least one user and one book before adding.");
        return;
      }
      console.log(
        "Adding",
        userIds.length * bookIds.length,
        "mapping(s)..."
      );
      setBusy(true);
      try {
        for (let i = 0; i < userIds.length; i++) {
          const uid = userIds[i];
          for (let j = 0; j < bookIds.length; j++) {
            const bid = bookIds[j];
            try {
              const resp = await fetch(
                "/admin/users_books/" + uid + "/filters",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken(),
                  },
                  credentials: "same-origin",
                  body: JSON.stringify({ book_id: bid, csrf_token: csrfToken() }),
                }
              );
              if (!resp.ok) {
                console.error(
                  "Add failed (u=", uid, " b=", bid, ") HTTP ", resp.status
                );
              } else {
                const d = await resp.json();
                console.log("u=", uid, " b=", bid, " -> ", d.status);
              }
            } catch (inner) {
              console.error("Error (u=", uid, " b=", bid, "):", inner);
            }
          }
        }
        console.log("Add operations complete.");
        await loadMappings();
      } finally {
        setBusy(false);
      }
    }
    function selectAll(container) {
      Array.from(container.querySelectorAll('input[type="checkbox"]')).forEach(
        (cb) => {
          if (cb.offsetParent !== null) cb.checked = true;
        }
      );
      updateSelectionCounts();
    }
    function clearAll(container) {
      Array.from(container.querySelectorAll('input[type="checkbox"]')).forEach(
        (cb) => {
          cb.checked = false;
        }
      );
      updateSelectionCounts();
    }
    function clearAllSelections() {
      clearAll(usersBox);
      clearAll(booksBox);
    }
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
    btnUsersReload.addEventListener("click", loadUsers);
    btnBooksReload.addEventListener("click", loadBooks);
    btnReloadMappings.addEventListener("click", loadMappings);
    btnUsersSelectAll.addEventListener("click", () => selectAll(usersBox));
    btnUsersClear.addEventListener("click", () => clearAll(usersBox));
    btnBooksSelectAll.addEventListener("click", () => selectAll(booksBox));
    btnBooksClear.addEventListener("click", () => clearAll(booksBox));
    btnAddMappings.addEventListener("click", addMappings);
    btnClearSelection.addEventListener("click", clearAllSelections);
    (async function init() {
      console.log("Initializing users_books admin interface...");
      await loadUsers();
      await loadBooks();
      await loadMappings();
      console.log("users_books admin interface ready.");
    })();
  })();
</script>
{% endblock %}
