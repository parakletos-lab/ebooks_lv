{% extends "layout.html" %}
{% set title = _('ebooks.lv Books') %}
{% block header %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('_app_templates.static', filename='ebookslv_admin.css') }}" />
{% endblock %}
{% block body %}
<div class="panel panel-default">
  <div class="panel-heading"><h3 class="panel-title">{{ _('ebooks.lv Books Sync') }}</h3></div>
  <div class="panel-body">
    <div class="mz-toolbar" id="mz-toolbar">
      <button id="btn-reload-calibre" class="btn btn-default btn-sm" type="button">{{ _('Reload Calibre Books') }}</button>
      <button id="btn-load-products" class="btn btn-info btn-sm" type="button">{{ _('Load Mozello Products') }}</button>
      <button id="btn-sync-prices" class="btn btn-primary btn-sm" type="button">{{ _('Sync Prices from Mozello') }}</button>
      <button id="btn-push-prices" class="btn btn-warning btn-sm" type="button">{{ _('Push Prices to Mozello') }}</button>
      <button id="btn-export-all" class="btn btn-success btn-sm" type="button">{{ _('Export All to Store') }}</button>
  <div class="mz-progress mz-hidden" id="mz-progress">
        <div class="mz-spinner"></div>
        <span id="mz-progress-text">0/0</span>
      </div>
    </div>
  <div class="table-responsive mz-table-wrap">
      <table class="table table-condensed table-striped" id="mz-books-table">
        <thead>
          <tr>
            <th>{{ _('Book ID') }}</th>
            <th>{{ _('Title') }}</th>
            <th>{{ _('Price') }}</th>
            <th class="mz-col">{{ _('Sync / State') }}</th>
            <th class="mz-col">{{ _('Delete') }}</th>
          </tr>
        </thead>
        <tbody id="mz-books-tbody"></tbody>
      </table>
    </div>
    <div class="mz-log" id="mz-log"></div>
  </div>
</div>
<script>
(function(){
  'use strict';
  const strings = {{ {
    "logLine": _('[%(timestamp)s] %(message)s', timestamp='%(timestamp)s', message='%(message)s'),
    "orphanPlaceholder": _('(orphan)'),
    "orphanBadge": _('ORPHAN'),
    "mozelloUrlTooltip": _('Mozello relative URL'),
    "exportButton": _('Export'),
    "deleteIconLabel": _('Delete'),
    "invalidJson": _('Invalid JSON response'),
    "loadingCalibre": _('Loading Calibre books...'),
    "calibreLoaded": _('Calibre books loaded: %(count)s', count='%(count)s'),
    "loadingProducts": _('Loading Mozello products...'),
    "productsLoaded": _('Mozello products loaded: %(products)s (orphans: %(orphans)s)', products='%(products)s', orphans='%(orphans)s'),
    "exportOneStart": _('Exporting book %(book_id)s...', book_id='%(book_id)s'),
    "exportOneSuccess": _('Exported book %(book_id)s.', book_id='%(book_id)s'),
    "exportOneError": _('Failed to export book %(book_id)s: %(reason)s', book_id='%(book_id)s', reason='%(reason)s'),
    "exportFailurePayload": _('Export failure payload: %(details)s', details='%(details)s'),
    "mozelloLanguageDetail": _('Mozello language: %(language)s', language='%(language)s'),
    "mozelloErrorDetail": _('Mozello error: %(message)s', message='%(message)s'),
    "mozelloUpdateRequest": _('Mozello update request: %(details)s', details='%(details)s'),
    "mozelloCreateRequest": _('Mozello create request: %(details)s', details='%(details)s'),
    "mozelloUpdateResponse": _('Mozello update response: %(details)s', details='%(details)s'),
    "mozelloResponse": _('Mozello response: %(details)s', details='%(details)s'),
    "mozelloCreateResponse": _('Mozello create response: %(details)s', details='%(details)s'),
    "mozelloFetchError": _('Mozello fetch error: %(details)s', details='%(details)s'),
    "exportFailureRaw": _('Export failure raw body: %(details)s', details='%(details)s'),
    "exportFailureStack": _('Export failure stack: %(details)s', details='%(details)s'),
    "exportAllStart": _('Export ALL started. Missing handles: %(total)s', total='%(total)s'),
    "exportAllSummary": _('Export ALL summary — success: %(success)s failed: %(failed)s', success='%(success)s', failed='%(failed)s'),
    "exportAllError": _('Export ALL failed: %(reason)s', reason='%(reason)s'),
    "syncPricesFromMozelloStart": _('Syncing prices from Mozello...'),
    "syncPricesFromMozelloDone": _('Synced %(updated)s prices from Mozello (orphans: %(orphans)s, missing: %(missing)s)', updated='%(updated)s', orphans='%(orphans)s', missing='%(missing)s'),
    "syncPricesFromMozelloError": _('Sync from Mozello failed: %(reason)s', reason='%(reason)s'),
    "pushPricesStart": _('Pushing Calibre prices to Mozello...'),
    "pushPricesDone": _('Pushed prices — success: %(success)s skipped: %(skipped)s failed: %(failed)s', success='%(success)s', skipped='%(skipped)s', failed='%(failed)s'),
    "pushPricesError": _('Push to Mozello failed: %(reason)s', reason='%(reason)s'),
    "deleteConfirm": _('Delete Mozello product %(handle)s?', handle='%(handle)s'),
    "deleteStart": _('Deleting Mozello product %(handle)s...', handle='%(handle)s'),
    "deleteSuccess": _('Deleted product %(handle)s (status %(status)s).', handle='%(handle)s', status='%(status)s'),
    "deleteError": _('Failed to delete product %(handle)s: %(reason)s', handle='%(handle)s', reason='%(reason)s'),
    "httpError": _('HTTP %(status)s %(status_text)s', status='%(status)s', status_text='%(status_text)s')
  } | tojson }};

  function formatMessage(template, replacements){
    if(typeof template !== 'string'){
      return '';
    }
    if(!replacements){
      return template;
    }
    return template.replace(/%\(([^)]+)\)s/g, function(match, key){
      if(Object.prototype.hasOwnProperty.call(replacements, key)){
        return replacements[key];
      }
      return match;
    });
  }

  function t(key, replacements){
    const template = Object.prototype.hasOwnProperty.call(strings, key) ? strings[key] : key;
    return formatMessage(template, replacements);
  }

  const tbody = document.getElementById('mz-books-tbody');
  const logBox = document.getElementById('mz-log');
  const btnReload = document.getElementById('btn-reload-calibre');
  const btnLoad = document.getElementById('btn-load-products');
  const btnSyncPrices = document.getElementById('btn-sync-prices');
  const btnPushPrices = document.getElementById('btn-push-prices');
  const btnExportAll = document.getElementById('btn-export-all');
  const toolbar = document.getElementById('mz-toolbar');
  const progWrap = document.getElementById('mz-progress');
  const progText = document.getElementById('mz-progress-text');
  let rows = [];

  function log(messageKey, level, replacements){
    let severity = level;
    let params = replacements;
    if(typeof severity === 'object' && params === undefined){
      params = severity;
      severity = undefined;
    }
    let content = messageKey;
    if(Object.prototype.hasOwnProperty.call(strings, messageKey)){
      content = t(messageKey, params);
    } else if(typeof messageKey === 'string'){
      content = formatMessage(messageKey, params);
    }
    const ts = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    if(severity === 'error'){
      line.classList.add('mz-log-line-error');
    }
    line.textContent = formatMessage(strings.logLine, {
      timestamp: ts,
      message: content,
    });
    logBox.appendChild(line);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function clearTable(){
    tbody.innerHTML = '';
  }

  function render(){
    clearTable();
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const tr = document.createElement('tr');
      if(r.orphan){
        tr.className = 'orphan-row';
      }
      const priceValue = r.mz_price;
      const missingPrice = (!r.orphan) && (priceValue == null || Number(priceValue) <= 0);
      if(missingPrice){
        tr.classList.add('mz-price-missing-row');
      }
      const fallbackTitle = r.orphan ? strings.orphanPlaceholder : '';
      tr.innerHTML = `
        <td>${r.book_id ?? '—'}</td>
        <td>${escapeHtml(r.title ?? fallbackTitle ?? '')}</td>
        <td>${r.mz_price != null ? r.mz_price : ''}</td>
        <td class="mz-col">${renderSyncCell(r)}</td>
        <td class="mz-col">${renderDeleteCell(r)}</td>`;
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  function renderSyncCell(r){
    if(r.mz_handle){
      const handlePath = encodeURIComponent(r.mz_handle);
      const mkLang = (lang, label) => `<a class="btn btn-default btn-xs mz-lang-btn" href="/mozello/books/${handlePath}?lang=${lang}" target="_blank" rel="noopener noreferrer">${label}</a>`;
      const actions = `<div class="mz-handle-actions">${mkLang('lv','LV')} ${mkLang('ru','RU')} ${mkLang('en','EN')}</div>`;
      if(r.orphan){
        const orphanLabel = `<span class="label label-danger">${escapeHtml(strings.orphanBadge)}</span>`;
        return `${orphanLabel}${actions}`;
      }
      return actions;
    }
    const buttonLabel = escapeHtml(strings.exportButton);
    return `<button class="btn btn-primary btn-xs" data-export="${r.book_id}">${buttonLabel}</button>`;
  }

  function renderDeleteCell(r){
    if(r.mz_handle || r.orphan){
      const label = escapeHtml(strings.deleteIconLabel);
      return `<button class="btn btn-danger btn-xs" data-del="${r.mz_handle || ''}" title="${label}" aria-label="${label}"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>`;
    }
    return '';
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  async function fetchJSON(url, opts){
    const response = await fetch(url, Object.assign({ credentials: 'same-origin' }, opts || {}));
    const text = await response.text();
    let payload = null;
    if(text){
      try {
        payload = JSON.parse(text);
      } catch(parseErr){
        payload = null;
      }
    }
    if(!response.ok){
      const statusText = response.statusText || '';
      const err = new Error(payload && payload.message ? payload.message : t('httpError', { status: response.status, status_text: statusText }));
      err.code = payload && payload.error ? payload.error : null;
      err.httpStatus = response.status;
      err.httpPayload = payload;
      err.httpRaw = text;
      throw err;
    }
    if(payload === null){
      throw new Error(strings.invalidJson);
    }
    return payload;
  }

  async function loadCalibre(){
    log('loadingCalibre');
    const data = await fetchJSON('/admin/ebookslv/books/api/data');
    rows = data.rows || [];
    render();
    log('calibreLoaded', { count: rows.length });
  }

  async function loadProducts(){
    log('loadingProducts');
    const data = await fetchJSON('/admin/ebookslv/books/api/load_products', { method: 'POST' });
    rows = data.rows || [];
    render();
    log('productsLoaded', { products: data.products || 0, orphans: data.orphans || 0 });
  }

  async function exportOne(bookId, btn){
    btn.disabled = true;
    try {
      log('exportOneStart', { book_id: bookId });
      const data = await fetchJSON('/admin/ebookslv/books/api/export_one/' + bookId, { method: 'POST' });
      const row = data.row;
      const idx = rows.findIndex(r => r.book_id === bookId);
      if(idx > -1){
        rows[idx] = row;
      }
      render();
      log('exportOneSuccess', { book_id: bookId });
    } catch(e){
      log('exportOneError', 'error', { book_id: bookId, reason: e && e.message ? e.message : '' });
      if(e && typeof e === 'object'){
        const payload = e.httpPayload;
        if(payload){
          const safeStringify = (value) => {
            try {
              return JSON.stringify(value);
            } catch(jsonErr){
              return String(value);
            }
          };
          log('exportFailurePayload', 'error', { details: safeStringify(payload) });
          const details = payload.details || {};
          if(details.language){
            log('mozelloLanguageDetail', 'error', { language: details.language });
          }
          const mozelloMsg = details.error_message || details.error_description || details.error;
          if(mozelloMsg){
            log('mozelloErrorDetail', 'error', { message: mozelloMsg });
          }
          const logJson = (key, obj) => {
            if(!obj){
              return;
            }
            log(key, 'error', { details: safeStringify(obj) });
          };
          logJson('mozelloUpdateRequest', details.update_request);
          logJson('mozelloCreateRequest', details.create_request);
          logJson('mozelloUpdateResponse', details.update_details);
          if(details.details && details.details !== details.update_details){
            logJson('mozelloResponse', details.details);
          }
          if(details.create_details){
            logJson('mozelloCreateResponse', details.create_details);
          }
          if(details.fetch_error){
            logJson('mozelloFetchError', details.fetch_error);
          }
        } else if(e.httpRaw){
          log('exportFailureRaw', 'error', { details: e.httpRaw });
        }
        if(e.stack){
          log('exportFailureStack', 'error', { details: e.stack.split('\n')[0] });
        }
      }
    }
  }

  function disableAll(disabled){
    [btnReload, btnLoad, btnSyncPrices, btnPushPrices, btnExportAll].forEach(b => {
      if(b){
        b.disabled = disabled;
      }
    });
    toolbar.classList.toggle('mz-disabled', disabled);
  }

  async function syncPricesFromMozello(){
    disableAll(true);
    log('syncPricesFromMozelloStart');
    try {
      const data = await fetchJSON('/admin/ebookslv/books/api/sync_prices_from_mozello', { method: 'POST' });
      rows = data.rows || rows;
      render();
      log('syncPricesFromMozelloDone', {
        updated: data.updated || 0,
        orphans: data.orphans || 0,
        missing: data.missing_price || 0,
      });
    } catch(e){
      log('syncPricesFromMozelloError', 'error', { reason: e && e.message ? e.message : '' });
    } finally {
      disableAll(false);
    }
  }

  async function pushPricesToMozello(){
    disableAll(true);
    log('pushPricesStart');
    try {
      const data = await fetchJSON('/admin/ebookslv/books/api/push_prices_to_mozello', { method: 'POST' });
      const summary = data.summary || {};
      log('pushPricesDone', {
        success: summary.success || 0,
        skipped: summary.skipped_same || 0,
        failed: summary.failed || 0,
      });
    } catch(e){
      log('pushPricesError', 'error', { reason: e && e.message ? e.message : '' });
    } finally {
      disableAll(false);
    }
  }

  async function exportAll(){
    disableAll(true);
    progWrap.classList.remove('mz-hidden');
    try {
      const calibreMissing = rows.filter(r => !r.orphan && !r.mz_handle && r.mz_price != null && Number(r.mz_price) > 0);
      const total = calibreMissing.length;
      progText.textContent = `0/${total}`;
      log('exportAllStart', { total });
      const data = await fetchJSON('/admin/ebookslv/books/api/export_all', { method: 'POST' });
      rows = data.rows || rows;
      render();
      const summary = data.summary || {};
      log('exportAllSummary', { success: summary.success || 0, failed: summary.failed || 0 });
    } catch(e){
      log('exportAllError', 'error', { reason: e && e.message ? e.message : '' });
    } finally {
      progWrap.classList.add('mz-hidden');
      disableAll(false);
    }
  }

  async function deleteHandle(handle){
    if(!handle){
      return;
    }
    if(!confirm(t('deleteConfirm', { handle }))){
      return;
    }
    log('deleteStart', { handle });
    try {
      const data = await fetchJSON('/admin/ebookslv/books/api/delete/' + handle, { method: 'DELETE' });
      rows = rows.filter(r => !(r.orphan && r.mz_handle === handle));
      rows.forEach(r => {
        if(r.mz_handle === handle){
          r.mz_handle = null;
          r.mozello_title = null;
          r.mozello_price = null;
          r.mz_relative_url = null;
        }
      });
      render();
      log('deleteSuccess', { handle, status: data.status || 'ok' });
    } catch(e){
      log('deleteError', 'error', { handle, reason: e && e.message ? e.message : '' });
    }
  }

  tbody.addEventListener('click', e => {
    const button = e.target.closest('[data-export], [data-del]');
    if(!button){
      return;
    }
    const exportId = button.getAttribute('data-export');
    if(exportId){
      exportOne(Number(exportId), button);
      return;
    }
    const deleteHandleValue = button.getAttribute('data-del');
    if(deleteHandleValue){
      deleteHandle(deleteHandleValue);
    }
  });

  btnReload.addEventListener('click', loadCalibre);
  btnLoad.addEventListener('click', loadProducts);
  btnSyncPrices.addEventListener('click', syncPricesFromMozello);
  btnPushPrices.addEventListener('click', pushPricesToMozello);
  btnExportAll.addEventListener('click', exportAll);
  loadCalibre();
})();
</script>
{% endblock %}
