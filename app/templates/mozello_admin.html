{% extends "layout.html" %}
{% set title = _('Mozello Notifications') %}
{% block header %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('_app_templates.static', filename='ebookslv_admin.css') }}" />
{% endblock %}
{% block body %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ _('Mozello Settings') }}</h3>
  </div>
  <div class="panel-body">
    <form id="mz-settings-form" class="form">
      <div class="form-group mz-admin-max-600">
        <div class="email-template-card-header mz-card-header-tight">
          <label for="mz-store-url-lv" class="mz-label-no-margin">{{ _('Mozello Store URL') }}</label>
          <div class="email-template-tabs" id="mz-store-url-tabs">
            <button type="button" class="email-template-tab is-active" data-lang="lv">LV</button>
            <button type="button" class="email-template-tab" data-lang="ru">RU</button>
            <button type="button" class="email-template-tab" data-lang="en">EN</button>
          </div>
        </div>
        <div class="email-template-editor-panes mz-editor-panes-tight" id="mz-store-url-panes">
          <div class="email-template-pane is-active" data-lang="lv">
            <input type="url" class="form-control" id="mz-store-url-lv" placeholder="https://example.mozello.com/store/" />
          </div>
          <div class="email-template-pane" data-lang="ru">
            <input type="url" class="form-control" id="mz-store-url-ru" placeholder="https://example.mozello.com/store/" />
          </div>
          <div class="email-template-pane" data-lang="en">
            <input type="url" class="form-control" id="mz-store-url-en" placeholder="https://example.mozello.com/store/" />
          </div>
        </div>
      </div>
      <div class="form-group mz-admin-max-600">
        <label for="mz-api-key">{{ _('Mozello API Key') }}</label>
        <input type="text" class="form-control" id="mz-api-key" autocomplete="off" />
      </div>
      <button type="button" id="mz-settings-save" class="btn btn-primary">
        <span class="glyphicon glyphicon-floppy-disk"></span> {{ _('Save Settings') }}
      </button>
      <button type="button" id="mz-settings-reload" class="btn btn-default">{{ _('Reload') }}</button>
    </form>
  </div>
</div>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ _('Mozello Notification Settings') }}</h3>
  </div>
  <div class="panel-body">
    <p class="text-muted ub-card-lead">
      {{ _('Manage subscribed webhook events. API key and store URL are configured above.') }}
    </p>
    <form id="mz-form" class="form">
      <div class="form-group">
        <label for="mz-url">{{ _('Candidate Webhook URL (computed)') }}</label>
        <input type="text" class="form-control" id="mz-url" readonly />
      </div>
      <div class="form-group">
        <label>{{ _('Events') }}</label>
        <div id="mz-events-box" class="mz-events-box">
          {% for ev in allowed %}
          <label class="mz-event-label">
            <input type="checkbox" value="{{ ev }}"> {{ ev }}
          </label>
          {% endfor %}
        </div>
      </div>
      <button type="button" id="mz-save" class="btn btn-primary">
        <span class="glyphicon glyphicon-floppy-disk"></span> {{ _('Update Remote') }}
      </button>
      <button type="button" id="mz-load" class="btn btn-default">{{ _('Load Remote') }}</button>
  <button type="button" id="mz-test" class="btn btn-default">{{ _('Post Test (unsigned)') }}</button>
  <button type="button" id="mz-reset" class="btn btn-default">{{ _('Reset URL') }}</button>
    </form>
    <hr />
    <h4 class="mz-h4-tight">{{ _('Current Settings') }}</h4>
    <pre id="mz-current" class="mz-current-pre">{{ _('(loading)') }}</pre>
  </div>
</div>

<script>
(function() {
  'use strict';
  const strings = {{ {
    "errorLoading": _('Error loading settings: %(reason)s', reason='%(reason)s'),
    "failedLoadSettings": _('Failed to load Mozello settings: %(reason)s', reason='%(reason)s'),
    "saveFailed": _('Save failed: %(reason)s', reason='%(reason)s'),
    "settingsSaved": _('Mozello settings saved.'),
    "failedSaveSettings": _('Failed to save Mozello settings: %(reason)s', reason='%(reason)s'),
    "unsignedPost": _('Unsigned webhook POST status: %(status)s\n%(body)s', status='%(status)s', body='%(body)s'),
    "httpError": _('HTTP %(status)s %(status_text)s', status='%(status)s', status_text='%(status_text)s')
  } | tojson }};

  function formatMessage(template, replacements){
    if(typeof template !== 'string'){
      return '';
    }
    if(!replacements){
      return template;
    }
    return template.replace(/%\(([^)]+)\)s/g, function(match, key){
      if(Object.prototype.hasOwnProperty.call(replacements, key)){
        return replacements[key];
      }
      return match;
    });
  }

  function t(key, replacements){
    const template = Object.prototype.hasOwnProperty.call(strings, key) ? strings[key] : key;
    return formatMessage(template, replacements);
  }

  function describeError(err){
    if(!err){
      return '';
    }
    if(err instanceof Error && err.message){
      return err.message;
    }
    return String(err);
  }
  // Original candidate URL provided on initial render (no remote fetch yet)
  const candidateURL = "{{ mozello.notifications_url }}";
  const box = document.getElementById('mz-events-box');
  const pre = document.getElementById('mz-current');
  const urlInput = document.getElementById('mz-url');
  const btnSave = document.getElementById('mz-save');
  const btnLoad = document.getElementById('mz-load');
  const btnTest = document.getElementById('mz-test');
  const btnReset = document.getElementById('mz-reset');
  const storeInputLv = document.getElementById('mz-store-url-lv');
  const storeInputRu = document.getElementById('mz-store-url-ru');
  const storeInputEn = document.getElementById('mz-store-url-en');
  const storeTabs = document.getElementById('mz-store-url-tabs');
  const storePanes = document.getElementById('mz-store-url-panes');
  const apiKeyInput = document.getElementById('mz-api-key');
  const btnSettingsSave = document.getElementById('mz-settings-save');
  const btnSettingsReload = document.getElementById('mz-settings-reload');
  const portInput = null; // removed forced port feature

  function switchStoreLang(lang){
    if(!storeTabs || !storePanes){
      return;
    }
    Array.from(storeTabs.querySelectorAll('.email-template-tab')).forEach(function(btn){
      btn.classList.toggle('is-active', btn.getAttribute('data-lang') === lang);
    });
    Array.from(storePanes.querySelectorAll('.email-template-pane')).forEach(function(pane){
      pane.classList.toggle('is-active', pane.getAttribute('data-lang') === lang);
    });
  }

  if(storeTabs){
    storeTabs.addEventListener('click', function(e){
      var btn = e.target && e.target.closest ? e.target.closest('button[data-lang]') : null;
      if(!btn){
        return;
      }
      var lang = btn.getAttribute('data-lang') || 'lv';
      switchStoreLang(lang);
    });
  }

  function selectedEvents() {
    return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
  }
  function setSelected(events) {
    const set = new Set(events || []);
    box.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = set.has(cb.value); });
  }
  async function fetchJSON(u, opts) {
    const r = await fetch(u, opts || {});
    if (!r.ok) throw new Error(t('httpError', { status: r.status, status_text: r.statusText || '' }));
    return r.json();
  }
  async function loadRemote() {
    try {
      const data = await fetchJSON('/admin/mozello/settings');
      pre.textContent = JSON.stringify(data, null, 2);
      // Prefer the actual remote URL if returned; fall back to candidate
      urlInput.value = data.remote_notifications_url || data.notifications_url || '';
      setSelected(data.notifications_wanted || []);
    } catch (e) {
      pre.textContent = t('errorLoading', { reason: describeError(e) });
    }
  }
  async function loadMozelloSettings() {
    try {
      const data = await fetchJSON('/admin/mozello/app_settings');
      const fallback = data.mz_store_url || '';
      storeInputLv.value = data.mz_store_url_lv || fallback;
      storeInputRu.value = data.mz_store_url_ru || fallback;
      storeInputEn.value = data.mz_store_url_en || fallback;
      apiKeyInput.value = data.mz_api_key || '';
    } catch (e) {
      alert(t('failedLoadSettings', { reason: describeError(e) }));
    }
  }
  async function saveSettings() {
    btnSave.disabled = true;
    try {
      const body = { notifications_wanted: selectedEvents() };
      const data = await fetchJSON('/admin/mozello/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      alert(t('saveFailed', { reason: describeError(e) }));
    } finally {
      btnSave.disabled = false;
    }
  }
  async function saveMozelloSettings() {
    btnSettingsSave.disabled = true;
    try {
      const body = {
        mz_store_url_lv: storeInputLv.value || '',
        mz_store_url_ru: storeInputRu.value || '',
        mz_store_url_en: storeInputEn.value || '',
        // Backward-compatible alias
        mz_store_url: storeInputEn.value || '',
        mz_api_key: apiKeyInput.value || ''
      };
      const data = await fetchJSON('/admin/mozello/app_settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const fallback = data.mz_store_url || '';
      storeInputLv.value = data.mz_store_url_lv || fallback;
      storeInputRu.value = data.mz_store_url_ru || fallback;
      storeInputEn.value = data.mz_store_url_en || fallback;
      if (Object.prototype.hasOwnProperty.call(data, 'mz_api_key')) {
        apiKeyInput.value = data.mz_api_key || '';
      }
      alert(strings.settingsSaved);
    } catch (e) {
      alert(t('failedSaveSettings', { reason: describeError(e) }));
    } finally {
      btnSettingsSave.disabled = false;
    }
  }
  async function postTest() {
    const fake = { event: 'PAYMENT_CHANGED', order: { payment_status: 'paid', test: true, ts: Date.now() } };
    const raw = JSON.stringify(fake);
    const r = await fetch('/mozello/webhook', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Mozello-Test': 'unsigned' }, body: raw });
    const t = await r.json();
    alert(t('unsignedPost', { status: r.status, body: JSON.stringify(t) }));
  }
  btnSave.addEventListener('click', saveSettings);
  btnLoad.addEventListener('click', loadRemote);
  btnReset.addEventListener('click', function() {
    urlInput.value = candidateURL || '';
  });
  btnTest.addEventListener('click', postTest);
  btnSettingsSave.addEventListener('click', saveMozelloSettings);
  btnSettingsReload.addEventListener('click', loadMozelloSettings);
  switchStoreLang('lv');
  loadMozelloSettings();
  // No automatic remote API call on load (conservative mode)
})();
</script>
{% endblock %}
