{% extends "layout.html" %}
{% set title = 'Mozello Notifications' %}
{% block body %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Mozello Settings</h3>
  </div>
  <div class="panel-body">
    <form id="mz-settings-form" class="form">
      <div class="form-group" style="max-width:600px;">
        <label for="mz-store-url">Mozello Store URL</label>
        <input type="url" class="form-control" id="mz-store-url" placeholder="https://example.mozello.com/store/" />
        <p class="help-block">Displayed in admin tools and used when cross-linking to the live storefront.</p>
      </div>
      <div class="form-group" style="max-width:600px;">
        <label for="mz-api-key">Mozello API Key</label>
        <input type="text" class="form-control" id="mz-api-key" autocomplete="off" />
        <p class="help-block">Stored in the integration database (<code>config/users_books.db</code>); required for API calls and webhook verification.</p>
      </div>
      <button type="button" id="mz-settings-save" class="btn btn-primary">
        <span class="glyphicon glyphicon-floppy-disk"></span> Save Settings
      </button>
      <button type="button" id="mz-settings-reload" class="btn btn-default">Reload</button>
    </form>
  </div>
</div>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Mozello Notification Settings</h3>
  </div>
  <div class="panel-body">
    <p class="text-muted" style="margin-top:-4px;">
      Manage subscribed webhook events. API key and store URL are configured above.
    </p>
    <form id="mz-form" class="form">
      <div class="form-group">
        <label for="mz-url">Candidate Webhook URL (computed)</label>
        <input type="text" class="form-control" id="mz-url" readonly />
        <p class="help-block">Not stored locally; used directly when you press Save.</p>
      </div>
      <div class="form-group">
        <label>Events</label>
        <div id="mz-events-box" style="border:1px solid #ddd; padding:6px; max-width:420px; background:#fafafa;">
          {% for ev in allowed %}
          <label style="display:block; font-weight:400;">
            <input type="checkbox" value="{{ ev }}"> {{ ev }}
          </label>
          {% endfor %}
        </div>
        <p class="help-block" style="margin-top:4px;">Select events to subscribe. Leave empty to unsubscribe all.</p>
      </div>
      <button type="button" id="mz-save" class="btn btn-primary">
        <span class="glyphicon glyphicon-floppy-disk"></span> Update Remote
      </button>
      <button type="button" id="mz-load" class="btn btn-default">Load Remote</button>
  <button type="button" id="mz-test" class="btn btn-default">Post Test (unsigned)</button>
  <button type="button" id="mz-reset" class="btn btn-default">Reset URL</button>
    </form>
    <hr />
    <h4 style="margin-top:0;">Current Settings</h4>
    <pre id="mz-current" style="background:#1e1e1e; color:#e6e6e6; padding:8px; max-width:600px; font-size:11px;">(loading)</pre>
  </div>
</div>

<script>
(function() {
  'use strict';
  // Original candidate URL provided on initial render (no remote fetch yet)
  const candidateURL = "{{ mozello.notifications_url }}";
  const box = document.getElementById('mz-events-box');
  const pre = document.getElementById('mz-current');
  const urlInput = document.getElementById('mz-url');
  const btnSave = document.getElementById('mz-save');
  const btnLoad = document.getElementById('mz-load');
  const btnTest = document.getElementById('mz-test');
  const btnReset = document.getElementById('mz-reset');
  const storeInput = document.getElementById('mz-store-url');
  const apiKeyInput = document.getElementById('mz-api-key');
  const btnSettingsSave = document.getElementById('mz-settings-save');
  const btnSettingsReload = document.getElementById('mz-settings-reload');
  const portInput = null; // removed forced port feature

  function selectedEvents() {
    return Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
  }
  function setSelected(events) {
    const set = new Set(events || []);
    box.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = set.has(cb.value); });
  }
  async function fetchJSON(u, opts) {
    const r = await fetch(u, opts || {});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function loadRemote() {
    try {
      const data = await fetchJSON('/admin/mozello/settings');
      pre.textContent = JSON.stringify(data, null, 2);
      // Prefer the actual remote URL if returned; fall back to candidate
      urlInput.value = data.remote_notifications_url || data.notifications_url || '';
      setSelected(data.notifications_wanted || []);
    } catch (e) {
      pre.textContent = 'Error loading settings: '+ e;
    }
  }
  async function loadMozelloSettings() {
    try {
      const data = await fetchJSON('/admin/mozello/app_settings');
      storeInput.value = data.mz_store_url || '';
      apiKeyInput.value = data.mz_api_key || '';
    } catch (e) {
      alert('Failed to load Mozello settings: '+ e);
    }
  }
  async function saveSettings() {
    btnSave.disabled = true;
    try {
      const body = { notifications_wanted: selectedEvents() };
      const data = await fetchJSON('/admin/mozello/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      alert('Save failed: '+ e);
    } finally {
      btnSave.disabled = false;
    }
  }
  async function saveMozelloSettings() {
    btnSettingsSave.disabled = true;
    try {
      const body = {
        mz_store_url: storeInput.value || '',
        mz_api_key: apiKeyInput.value || ''
      };
      const data = await fetchJSON('/admin/mozello/app_settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      storeInput.value = data.mz_store_url || '';
      if (Object.prototype.hasOwnProperty.call(data, 'mz_api_key')) {
        apiKeyInput.value = data.mz_api_key || '';
      }
      alert('Mozello settings saved.');
    } catch (e) {
      alert('Failed to save Mozello settings: '+ e);
    } finally {
      btnSettingsSave.disabled = false;
    }
  }
  async function postTest() {
    const fake = { event: 'PAYMENT_CHANGED', order: { payment_status: 'paid', test: true, ts: Date.now() } };
    const raw = JSON.stringify(fake);
    const r = await fetch('/mozello/webhook', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Mozello-Test': 'unsigned' }, body: raw });
    const t = await r.json();
    alert('Unsigned webhook POST status: '+ r.status +'\n'+ JSON.stringify(t));
  }
  btnSave.addEventListener('click', saveSettings);
  btnLoad.addEventListener('click', loadRemote);
  btnReset.addEventListener('click', function() {
    urlInput.value = candidateURL || '';
  });
  btnTest.addEventListener('click', postTest);
  btnSettingsSave.addEventListener('click', saveMozelloSettings);
  btnSettingsReload.addEventListener('click', loadMozelloSettings);
  loadMozelloSettings();
  // No automatic remote API call on load (conservative mode)
})();
</script>
{% endblock %}
