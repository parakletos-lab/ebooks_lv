{% extends "layout.html" %}
{% set title = _('Email Templates') %}
{% block header %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('_app_templates.static', filename='ebookslv_admin.css') }}" />
  <script src="{{ url_for('static', filename='js/libs/tinymce/tinymce.min.js') }}"></script>
{% endblock %}
{% block body %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ _('Email Templates') }}</h3>
    <input type="hidden" id="email-templates-csrf" value="{{ ub_csrf_token|default('') }}" />
  </div>
  <div class="panel-body" id="email-templates-root" data-context="{{ templates_context|tojson|forceescape }}">
    {% for tmpl in templates_context.templates %}
    <div class="email-template-card" data-template-key="{{ tmpl.key }}" data-active-lang="{{ templates_context.languages[0] if templates_context.languages else '' }}">
      <div class="email-template-card-header">
        <div class="email-template-label">{{ tmpl.label }}</div>
        <div class="email-template-tabs">
          {% for lang in templates_context.languages %}
          <button type="button" class="email-template-tab{% if loop.first %} is-active{% endif %}" data-lang="{{ lang }}">
            {{ lang.upper() }}
          </button>
          {% endfor %}
        </div>
      </div>
      {% if tmpl.description %}
      <p class="text-muted email-template-description">{{ tmpl.description }}</p>
      {% endif %}
      <div class="email-template-editor-panes">
        {% for lang in templates_context.languages %}
        {% set details = tmpl.languages.get(lang) %}
        <div class="email-template-pane{% if loop.first %} is-active{% endif %}" data-lang="{{ lang }}">
          <div class="form-group email-template-subject-group">
            <label for="email-template-subject-{{ tmpl.key }}-{{ lang }}">{{ _('Subject') }}</label>
            <input
              type="text"
              id="email-template-subject-{{ tmpl.key }}-{{ lang }}"
              class="form-control input-sm email-template-subject-input"
              data-template-key="{{ tmpl.key }}"
              data-language="{{ lang }}"
              maxlength="255"
              value="{{ (details.subject if details else '')|e }}"
              aria-label="{{ tmpl.label }} subject ({{ lang.upper() }})"
            />
          </div>
          <textarea
            id="email-template-{{ tmpl.key }}-{{ lang }}"
            class="form-control email-template-textarea"
            rows="14"
            data-template-key="{{ tmpl.key }}"
            data-language="{{ lang }}"
            aria-label="{{ tmpl.label }} ({{ lang.upper() }})"
          >{{ (details.html if details else '')|e }}</textarea>
          <div class="email-template-updated text-muted">
            {% if details and details.updated_at %}
            {{ _('Last saved: %(timestamp)s', timestamp=details.updated_at) }}
            {% else %}
            {{ _('Not saved yet') }}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="email-template-token-bar">
        <span>{{ _('Tokens:') }}</span>
        {% set token_list = tmpl.tokens or templates_context.tokens %}
        {% for token in token_list %}
        <button type="button" class="btn btn-default btn-xs email-token-btn" data-token="{{ token.value }}">
          {{ token.label }}
        </button>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    {% if not templates_context.templates %}
    <p class="text-muted">{{ _('No templates configured yet.') }}</p>
    {% else %}
    <div class="email-templates-footer">
      <button type="button" class="btn btn-primary btn-sm" id="email-templates-save-all">{{ _('Save all templates') }}</button>
      <span id="email-templates-save-status" class="text-muted"></span>
    </div>
    {% endif %}
  </div>
</div>
<script>
(function(){
  "use strict";
  var strings = {{ {
    "lastSaved": _('Last saved: %(timestamp)s', timestamp='%(timestamp)s'),
    "notSavedYet": _('Not saved yet'),
    "savingAll": _('Saving all templates...'),
    "saveSummaryFailed": _('Saved %(success)s / %(total)s templates. Failed: %(failed)s', success='%(success)s', total='%(total)s', failed='%(failed)s'),
    "saveSummarySuccess": _('Saved %(count)s templates.', count='%(count)s')
  } | tojson }};

  function formatMessage(template, replacements){
    if(typeof template !== "string"){
      return "";
    }
    if(!replacements){
      return template;
    }
    return template.replace(/%\(([^)]+)\)s/g, function(match, key){
      if(Object.prototype.hasOwnProperty.call(replacements, key)){
        return replacements[key];
      }
      return match;
    });
  }

  function t(key, replacements){
    var template = Object.prototype.hasOwnProperty.call(strings, key) ? strings[key] : key;
    return formatMessage(template, replacements);
  }

  var root = document.getElementById("email-templates-root");
  if(!root){
    return;
  }
  var context;
  try {
    context = JSON.parse(root.getAttribute("data-context") || "{}");
  } catch(err) {
    context = {};
  }
  var langOrder = (context && context.languages) || [];
  var csrfInput = document.getElementById("email-templates-csrf");

  function getEditorValue(textarea){
    var editor = textarea && window.tinymce ? tinymce.get(textarea.id) : null;
    if(editor){
      return editor.getContent();
    }
    return textarea ? textarea.value : "";
  }

  function updatePaneTimestamp(templateKey, language, updatedAt){
    var selector = '.email-template-card[data-template-key="' + templateKey + '"] .email-template-pane[data-lang="' + language + '"] .email-template-updated';
    var el = document.querySelector(selector);
    if(!el){
      return;
    }
    if(updatedAt){
      el.textContent = t("lastSaved", { timestamp: updatedAt });
    } else {
      el.textContent = strings.notSavedYet;
    }
  }

  function setEditorFocus(textarea){
    if(!textarea || !window.tinymce){
      return;
    }
    var editor = tinymce.get(textarea.id);
    if(editor){
      editor.focus();
    }
  }

  function initEditors(){
    if(typeof tinymce === "undefined"){
      return;
    }
    tinymce.init({
      selector: ".email-template-textarea",
      plugins: "code",
      menubar: "edit view format",
      branding: false,
      height: 320,
      language: window.language || "en",
      setup: function(editor){
        editor.on("change keyup", function(){
          editor.save();
        });
      }
    });
  }

  function insertToken(card, tokenValue){
    var activePane = card.querySelector(".email-template-pane.is-active textarea");
    if(!activePane){
      return;
    }
    if(window.tinymce){
      var editor = tinymce.get(activePane.id);
      if(editor){
        editor.focus();
        editor.selection.setContent(tokenValue);
        editor.save();
        return;
      }
    }
    var start = activePane.selectionStart || 0;
    var end = activePane.selectionEnd || 0;
    var value = activePane.value || "";
    activePane.value = value.slice(0, start) + tokenValue + value.slice(end);
  }

  function switchLanguage(card, lang){
    var tabs = card.querySelectorAll(".email-template-tab");
    var panes = card.querySelectorAll(".email-template-pane");
    tabs.forEach(function(btn){
      btn.classList.toggle("is-active", btn.getAttribute("data-lang") === lang);
    });
    panes.forEach(function(pane){
      var isMatch = pane.getAttribute("data-lang") === lang;
      pane.classList.toggle("is-active", isMatch);
      if(isMatch){
        var textarea = pane.querySelector("textarea");
        setEditorFocus(textarea);
      }
    });
    card.setAttribute("data-active-lang", lang);
  }

  function saveAllTemplates(){
    var panes = document.querySelectorAll(".email-template-pane");
    var statusEl = document.getElementById("email-templates-save-status");
    var saveBtn = document.getElementById("email-templates-save-all");
    if(!panes.length || !saveBtn){
      return;
    }
    if(window.tinymce && typeof tinymce.triggerSave === "function"){
      tinymce.triggerSave();
    }
    var headers = {"Content-Type": "application/json"};
    if(csrfInput && csrfInput.value){
      headers["X-CSRFToken"] = csrfInput.value;
    }
    var payloads = Array.prototype.map.call(panes, function(pane){
      var area = pane.querySelector(".email-template-textarea");
      var subjectInput = pane.querySelector(".email-template-subject-input");
      return {
        template_key: area ? area.getAttribute("data-template-key") : (subjectInput ? subjectInput.getAttribute("data-template-key") : null),
        language: area ? area.getAttribute("data-language") : (subjectInput ? subjectInput.getAttribute("data-language") : null),
        subject: subjectInput ? subjectInput.value : "",
        html: getEditorValue(area),
      };
    }).filter(function(payload){
      return payload.template_key && payload.language;
    });
    if(!payloads.length){
      return;
    }
    saveBtn.disabled = true;
    if(statusEl){
      statusEl.textContent = strings.savingAll;
      statusEl.className = "text-muted";
    }
    var successes = 0;
    var failures = [];

    function postPayload(payload){
      return fetch("/admin/ebookslv/email-templates/api/save", {
        method: "POST",
        headers: headers,
        body: JSON.stringify(payload)
      })
        .then(function(resp){
          return resp.json().then(function(data){
            if(!resp.ok){
              var message = (data && data.error) || (resp.status + " error");
              throw new Error(message);
            }
            return data;
          });
        });
    }

    var chain = Promise.resolve();
    payloads.forEach(function(payload){
      chain = chain.then(function(){
        return postPayload(payload)
          .then(function(data){
            successes += 1;
            var ts = data && data.template ? data.template.updated_at : null;
            updatePaneTimestamp(payload.template_key, payload.language, ts);
          })
          .catch(function(err){
            failures.push({ language: payload.language, template: payload.template_key, error: err.message || String(err) });
          });
      });
    });

    chain.finally(function(){
      saveBtn.disabled = false;
      if(statusEl){
        if(failures.length){
          var failed = failures.map(function(item){
            return (item.template || "?") + " / " + (item.language || "").toUpperCase();
          }).join(", ");
          statusEl.textContent = t("saveSummaryFailed", { success: successes, total: payloads.length, failed: failed });
          statusEl.className = "text-danger";
        } else {
          statusEl.textContent = t("saveSummarySuccess", { count: successes });
          statusEl.className = "text-success";
        }
      }
    });
  }

  function wireCard(card){
    var tabs = card.querySelectorAll(".email-template-tab");
    var initialLang = null;
    if(langOrder.length){
      initialLang = langOrder[0];
    } else if(tabs.length){
      initialLang = tabs[0].getAttribute("data-lang");
    }
    if(initialLang){
      card.setAttribute("data-active-lang", initialLang);
      switchLanguage(card, initialLang);
    }
    tabs.forEach(function(btn){
      btn.addEventListener("click", function(){
        var lang = btn.getAttribute("data-lang");
        switchLanguage(card, lang);
      });
    });
    card.querySelectorAll(".email-token-btn").forEach(function(btn){
      btn.addEventListener("click", function(){
        insertToken(card, btn.getAttribute("data-token"));
      });
    });
  }

  document.querySelectorAll(".email-template-card").forEach(function(card){
    wireCard(card);
  });

  var globalSaveBtn = document.getElementById("email-templates-save-all");
  if(globalSaveBtn){
    globalSaveBtn.addEventListener("click", function(){
      saveAllTemplates();
    });
  }

  initEditors();
})();
</script>
{% endblock %}
