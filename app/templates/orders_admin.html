{% extends "layout.html" %}
{% set title = _('Mozello Orders') %}
{% block header %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('_app_templates.static', filename='ebookslv_admin.css') }}" />
{% endblock %}
{% block body %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ _('Mozello Orders') }}</h3>
    <input type="hidden" id="orders-csrf" value="{{ ub_csrf_token|default('') }}" />
  </div>
  <div class="panel-body">
    <form id="orders-import-form" class="form-inline ub-margin-b-8" autocomplete="off">
      <div class="form-group">
        <label class="sr-only" for="orders-start-date">{{ _('From') }}</label>
        <input type="date" class="form-control input-sm" id="orders-start-date" />
      </div>
      <div class="form-group ub-form-group-gap">
        <label class="sr-only" for="orders-end-date">{{ _('To') }}</label>
        <input type="date" class="form-control input-sm" id="orders-end-date" />
      </div>
      <button type="button" class="btn btn-success btn-sm" id="orders-import">{{ _('Import paid Mozello orders') }}</button>
    </form>
    <form id="orders-create-form" class="form-inline ub-margin-b-16" autocomplete="off">
      <div class="form-group">
        <label class="sr-only" for="orders-email">{{ _('Email') }}</label>
        <input type="email" class="form-control input-sm" id="orders-email" placeholder="{{ _('customer@example.com') }}" required />
      </div>
      <div class="form-group ub-form-group-gap">
        <label class="sr-only" for="orders-handle">{{ _('Mozello handle') }}</label>
        <input type="text" class="form-control input-sm" id="orders-handle" placeholder="{{ _('mozello-handle') }}" required />
      </div>
      <button type="submit" class="btn btn-primary btn-sm">{{ _('Add Order') }}</button>
      <button type="button" class="btn btn-default btn-sm" id="orders-refresh">{{ _('Reload') }}</button>
    </form>
  <div id="orders-alert" class="alert hidden"></div>
    <div class="text-muted ub-micro" id="orders-summary"></div>
    <div class="table-responsive ub-table-gap">
      <table class="table table-condensed table-striped" id="orders-table">
        <thead>
          <tr class="ub-sticky-top">
            <th class="ub-w-bookid">{{ _('Mozello handle') }}</th>
            <th>{{ _('Calibre book') }}</th>
            <th class="ub-w-email">{{ _('Email') }}</th>
            <th>{{ _('Calibre user') }}</th>
            <th class="ub-w-date">{{ _('Mozello created') }}</th>
            <th class="ub-w-date">{{ _('Imported') }}</th>
            <th class="ub-w-actions">{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody id="orders-table-body"></tbody>
      </table>
    </div>
  </div>
</div>
<script>
(function(){
  "use strict";
  const api = {
    list: "/admin/ebookslv/orders/api/list",
    create: "/admin/ebookslv/orders/api/create",
    createUser: (id) => `/admin/ebookslv/orders/api/${id}/create_user`,
    refresh: (id) => `/admin/ebookslv/orders/api/${id}/refresh`,
    remove: (id) => `/admin/ebookslv/orders/api/${id}`,
    importPaid: "/admin/ebookslv/orders/api/import_paid"
  };
  const translations = {{ {
    "summaryLine": _('Total: %(total)s | Linked books: %(books)s | Linked users: %(users)s', total='%(total)s', books='%(books)s', users='%(users)s'),
    "noOrders": _('No orders recorded.'),
    "bookFallback": _('Book #%(id)s', id='%(id)s'),
    "bookMissing": _('Calibre book missing'),
    "refresh": _('Refresh'),
    "userFallback": _('User #%(id)s', id='%(id)s'),
    "notLinked": _('Not linked'),
    "createUser": _('Create User'),
    "delete": _('Delete'),
    "emailHandleRequired": _('Email and Mozello handle are required'),
    "orderSaved": _('Order saved'),
    "orderSaveFailed": _('Unable to save order: %(message)s', message='%(message)s'),
    "loadFailed": _('Failed to load orders: %(message)s', message='%(message)s'),
    "importValidateRange": _('Invalid date range: start must be on or before end'),
    "importInvalidDate": _('Invalid date: please select a valid calendar day.'),
    "importDateRangeError": _('Invalid date range: start must be on or before end.'),
    "importFailed": _('Mozello import failed: %(message)s', message='%(message)s'),
    "importSummary": _('Import finished: %(summary)s.', summary='%(summary)s'),
    "importSummaryNew": _('%(count)s new', count='%(count)s'),
    "importSummaryExisting": _('%(count)s existing ignored', count='%(count)s'),
    "importSummarySkipped": _('%(count)s skipped', count='%(count)s'),
    "importSummaryErrors": _('%(count)s errors', count='%(count)s'),
    "createUserCreated": _('Calibre user created. Temporary password: %(password)s', password='%(password)s'),
    "createUserLinked": _('Linked to existing user.'),
    "createUserFailed": _('Create user failed: %(message)s', message='%(message)s'),
    "refreshFailed": _('Refresh failed: %(message)s', message='%(message)s'),
    "deleteConfirm": _('Delete this order record? This does not affect Mozello.'),
    "deleteFailed": _('Delete failed: %(message)s', message='%(message)s'),
    "deleteSuccess": _('Order deleted')
  } | tojson }};
  const form = document.getElementById("orders-create-form");
  const emailInput = document.getElementById("orders-email");
  const handleInput = document.getElementById("orders-handle");
  const refreshBtn = document.getElementById("orders-refresh");
  const importBtn = document.getElementById("orders-import");
  const importStartInput = document.getElementById("orders-start-date");
  const importEndInput = document.getElementById("orders-end-date");
  const alertBox = document.getElementById("orders-alert");
  const summaryBox = document.getElementById("orders-summary");
  const tableBody = document.getElementById("orders-table-body");
  const csrfInput = document.getElementById("orders-csrf");

  function csrfToken(){
    return csrfInput ? csrfInput.value : "";
  }

  function formatDateInput(date){
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  function primeDefaultDateRange(){
    if(!importStartInput || !importEndInput) return;
    if(importStartInput.value || importEndInput.value) return;
    const today = new Date();
    const endValue = formatDateInput(today);
    const startBaseline = new Date(today);
    startBaseline.setDate(startBaseline.getDate() - 9);
    importStartInput.value = formatDateInput(startBaseline);
    importEndInput.value = endValue;
  }

  function formatMessage(template, replacements){
    if(!template){
      return "";
    }
    return template.replace(/%\(([^)]+)\)s/g, function(match, key){
      if(replacements && Object.prototype.hasOwnProperty.call(replacements, key)){
        return replacements[key];
      }
      return match;
    });
  }

  function showAlert(message, type="info"){
    if(!alertBox) return;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove("hidden");
    alertBox.textContent = message;
  }

  function hideAlert(){
    if(alertBox){
      alertBox.className = "alert hidden";
      alertBox.textContent = "";
    }
  }

  function renderSummary(summary){
    if(!summaryBox) return;
    summaryBox.textContent = formatMessage(translations.summaryLine, {
      total: summary.total || 0,
      books: summary.linked_books || 0,
      users: summary.linked_users || 0
    });
  }

  function renderRows(rows){
    tableBody.innerHTML = "";
    if(!rows || !rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 7;
      td.className = "text-muted";
      td.textContent = translations.noOrders;
      tr.appendChild(td);
      tableBody.appendChild(tr);
      return;
    }
    const frag = document.createDocumentFragment();
    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.dataset.orderId = row.id;
      tr.innerHTML = `
        <td><code>${escapeHtml(row.mz_handle || "")}</code></td>
        <td>${renderBookCell(row)}</td>
        <td>${escapeHtml(row.email || "")}</td>
        <td>${renderUserCell(row)}</td>
        <td>${renderDateCell(row.created_at)}</td>
        <td>${renderDateCell(row.imported_at)}</td>
        <td>${renderActionsCell(row)}</td>`;
      frag.appendChild(tr);
    });
    tableBody.appendChild(frag);
  }

  function renderBookCell(row){
    if(row.calibre_book){
      const title = row.calibre_book.title || formatMessage(translations.bookFallback, { id: row.calibre_book.book_id });
      return `<span class="text-success">${escapeHtml(title)}</span>`;
    }
    const message = row.book_error || translations.bookMissing;
    const refreshBtn = `<button type="button" class="btn btn-xs btn-default orders-btn-refresh" data-order="${row.id}">${escapeHtml(translations.refresh)}</button>`;
    return `<span class="text-danger">${escapeHtml(message)}</span> ${refreshBtn}`;
  }

  function renderUserCell(row){
    if(!row.user_missing && row.calibre_user){
      const name = row.calibre_user.name || formatMessage(translations.userFallback, { id: row.calibre_user.id });
      return `<span class="text-success">${escapeHtml(name)}</span>`;
    }
    const btn = `<button type="button" class="btn btn-xs btn-primary orders-btn-create-user" data-order="${row.id}">${escapeHtml(translations.createUser)}</button>`;
    return `<span class="text-muted">${escapeHtml(translations.notLinked)}</span> ${btn}`;
  }

  function renderDateCell(value){
    if(!value){
      return '<span class="text-muted">â€”</span>';
    }
    try{
      const d = new Date(value);
      if(Number.isNaN(d.getTime())){
        return `<span>${escapeHtml(value)}</span>`;
      }
      return `<time datetime="${escapeHtml(value)}">${escapeHtml(d.toLocaleString())}</time>`;
    }catch(err){
      return `<span>${escapeHtml(String(value))}</span>`;
    }
  }

  function renderActionsCell(row){
    const label = escapeHtml(translations.delete);
    return `<button type="button" class="btn btn-xs btn-danger orders-btn-delete" data-order="${row.id}" title="${label}" aria-label="${label}"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>`;
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, function(ch){
      return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch] || ch;
    });
  }

  async function apiFetch(url, options){
    const opts = options || {};
    opts.headers = opts.headers || {};
    if(opts.method && opts.method !== "GET"){
      opts.headers["Content-Type"] = "application/json";
      const tok = csrfToken();
      if(tok) opts.headers["X-CSRFToken"] = tok;
    }
    const response = await fetch(url, opts);
    const data = await response.json().catch(() => ({}));
    if(!response.ok){
      const message = data && data.error ? data.error : `HTTP ${response.status}`;
      throw new Error(message);
    }
    return data;
  }

  async function loadOrders(){
    hideAlert();
    try{
      const data = await apiFetch(api.list);
      renderRows(data.orders || []);
      renderSummary(data.summary || {});
    }catch(err){
      showAlert(formatMessage(translations.loadFailed, { message: err.message || err }), "danger");
    }
  }

  primeDefaultDateRange();

  form.addEventListener("submit", async (evt) => {
    evt.preventDefault();
    const email = emailInput.value.trim();
    const handle = handleInput.value.trim();
    if(!email || !handle){
      showAlert(translations.emailHandleRequired, "warning");
      return;
    }
    hideAlert();
    try{
      await apiFetch(api.create, {
        method: "POST",
        body: JSON.stringify({ email, mz_handle: handle })
      });
      showAlert(translations.orderSaved, "success");
      emailInput.value = "";
      handleInput.value = "";
      await loadOrders();
    }catch(err){
      showAlert(formatMessage(translations.orderSaveFailed, { message: err.message || err }), "danger");
    }
  });

  refreshBtn.addEventListener("click", async () => {
    hideAlert();
    await loadOrders();
  });

  if(importBtn){
    importBtn.addEventListener("click", async () => {
      hideAlert();
      const startValue = importStartInput ? importStartInput.value : "";
      const endValue = importEndInput ? importEndInput.value : "";
      if(startValue && endValue && startValue > endValue){
        showAlert(translations.importValidateRange, "warning");
        return;
      }
      importBtn.disabled = true;
      try{
        const payload = {};
        if(startValue){
          payload.start_date = startValue;
        }
        if(endValue){
          payload.end_date = endValue;
        }
        const data = await apiFetch(api.importPaid, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const summary = data.summary || {};
        const created = summary.created || 0;
        const existing = summary.skipped_existing || 0;
        const filtered = summary.skipped_filtered || 0;
        const skipped = typeof summary.skipped === "number" ? summary.skipped : (existing + filtered);
        const errors = Array.isArray(summary.errors) ? summary.errors.length : 0;
        const parts = [];
        parts.push(formatMessage(translations.importSummaryNew, { count: created }));
        if(existing){
          parts.push(formatMessage(translations.importSummaryExisting, { count: existing }));
        }
        if(skipped){
          parts.push(formatMessage(translations.importSummarySkipped, { count: skipped }));
        }
        if(errors){
          parts.push(formatMessage(translations.importSummaryErrors, { count: errors }));
        }
        const summaryLine = parts.join(", ");
        showAlert(formatMessage(translations.importSummary, { summary: summaryLine }), "success");
        await loadOrders();
      }catch(err){
        const message = err && err.message ? String(err.message) : "";
        if(message === "invalid_date"){
          showAlert(translations.importInvalidDate, "warning");
        }else if(message === "invalid_date_range"){
          showAlert(translations.importDateRangeError, "warning");
        }else{
          showAlert(formatMessage(translations.importFailed, { message: err.message || err }), "danger");
        }
      }finally{
        importBtn.disabled = false;
      }
    });
  }

  tableBody.addEventListener("click", async (evt) => {
    const createBtn = evt.target.closest(".orders-btn-create-user");
    const refreshRowBtn = evt.target.closest(".orders-btn-refresh");
    const deleteBtn = evt.target.closest(".orders-btn-delete");
    if(createBtn){
      const orderId = Number(createBtn.getAttribute("data-order"));
      if(!orderId) return;
      createBtn.disabled = true;
      try{
        const data = await apiFetch(api.createUser(orderId), { method: "POST" });
        const message = data.password ?
          formatMessage(translations.createUserCreated, { password: data.password }) :
          translations.createUserLinked;
        showAlert(message, "success");
        await loadOrders();
      }catch(err){
        showAlert(formatMessage(translations.createUserFailed, { message: err.message || err }), "danger");
      }finally{
        createBtn.disabled = false;
      }
    }
    if(refreshRowBtn){
      const orderId = Number(refreshRowBtn.getAttribute("data-order"));
      if(!orderId) return;
      refreshRowBtn.disabled = true;
      try{
        await apiFetch(api.refresh(orderId), { method: "POST" });
        await loadOrders();
      }catch(err){
        showAlert(formatMessage(translations.refreshFailed, { message: err.message || err }), "danger");
      }finally{
        refreshRowBtn.disabled = false;
      }
    }
    if(deleteBtn){
      const orderId = Number(deleteBtn.getAttribute("data-order"));
      if(!orderId) return;
      if(!window.confirm(translations.deleteConfirm)){
        return;
      }
      deleteBtn.disabled = true;
      try{
        await apiFetch(api.remove(orderId), { method: "DELETE" });
        showAlert(translations.deleteSuccess, "success");
        await loadOrders();
      }catch(err){
        showAlert(formatMessage(translations.deleteFailed, { message: err.message || err }), "danger");
      }finally{
        deleteBtn.disabled = false;
      }
    }
  });

  loadOrders();
})();
</script>
{% endblock %}
