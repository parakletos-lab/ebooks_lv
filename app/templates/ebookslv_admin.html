{% extends "layout.html" %}
{% set title = _('ebooks.lv Admin') %}
{% block header %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('_app_templates.static', filename='ebookslv_admin.css') }}" />
{% endblock %}
{% block body %}
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">{{ _('ebooks.lv Administration') }}</h3>
  </div>
  <div class="panel-body">
    <input type="hidden" id="ebookslv-csrf" value="{{ ub_csrf_token|default('') }}" />
    <p class="text-muted ub-card-lead">{{ _('Central hub for ebooks.lv custom admin tools.') }}</p>
    <button type="button" class="btn btn-warning btn-sm" id="ebookslv-defaults-btn">{{ _('Set default settings') }}</button>
    <p id="ebookslv-defaults-status" class="ub-micro ub-help-margin text-muted"></p>
    <div class="ebooks-admin-cards">
      <div class="ebooks-admin-card">
        <h4><span class="glyphicon glyphicon-list-alt"></span> {{ _('Orders') }}</h4>
        <p>{{ _('Review Mozello orders, link Calibre books and provision user accounts.') }}</p>
        <a href="/admin/ebookslv/orders/" class="btn btn-primary btn-sm">{{ _('Open') }}</a>
      </div>
      <div class="ebooks-admin-card">
        <h4><span class="glyphicon glyphicon-flash"></span> {{ _('Mozello') }}</h4>
        <p>{{ _('Manage Mozello store settings and webhook notifications.') }}</p>
        <a href="/admin/ebookslv/mozello/" class="btn btn-warning btn-sm">{{ _('Open') }}</a>
      </div>
      <div class="ebooks-admin-card">
        <h4><span class="glyphicon glyphicon-book"></span> {{ _('Books') }}</h4>
        <p>{{ _('Sync Calibre books with Mozello store (export products, sync prices, delete products).') }}</p>
        <a href="/admin/ebookslv/books/" class="btn btn-info btn-sm">{{ _('Open') }}</a>
      </div>
      <div class="ebooks-admin-card">
        <h4><span class="glyphicon glyphicon-info-sign"></span> {{ _('Operator manual') }}</h4>
        <p>{{ _('Non-technical manuals for day-to-day operations.') }}</p>
        <a href="/admin/ebookslv/operator-manual/" class="btn btn-default btn-sm">{{ _('Open') }}</a>
      </div>
      <div class="ebooks-admin-card">
        <h4><span class="glyphicon glyphicon-envelope"></span> {{ _('Email Templates') }}</h4>
        <p>{{ _('Manage purchase notification templates across languages.') }}</p>
        <a href="/admin/ebookslv/email-templates/" class="btn btn-success btn-sm">{{ _('Open') }}</a>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  "use strict";
  var strings = {{ {
    "applyStart": _('Applying defaults...'),
    "applySuccess": _('Defaults applied.'),
    "applyFailure": _('Failed to apply defaults: %(reason)s', reason='%(reason)s')
  } | tojson }};
  var applyBtn = document.getElementById("ebookslv-defaults-btn");
  if(!applyBtn){
    return;
  }
  var statusEl = document.getElementById("ebookslv-defaults-status");
  var csrfInput = document.getElementById("ebookslv-csrf");

  function formatMessage(template, replacements){
    if(!template){
      return "";
    }
    return template.replace(/%\(([^)]+)\)s/g, function(match, key){
      if(replacements && Object.prototype.hasOwnProperty.call(replacements, key)){
        return replacements[key];
      }
      return match;
    });
  }

  function setStatus(message, level){
    if(!statusEl){
      return;
    }
    var base = "ub-micro ub-help-margin";
    var tone = "text-muted";
    if(level === "success"){
      tone = "text-success";
    } else if(level === "error"){
      tone = "text-danger";
    }
    statusEl.className = base + " " + tone;
    statusEl.textContent = message;
  }

  applyBtn.addEventListener("click", function(){
    setStatus(strings.applyStart, "info");
    applyBtn.disabled = true;
    var headers = {"Content-Type": "application/json"};
    if(csrfInput && csrfInput.value){
      headers["X-CSRFToken"] = csrfInput.value;
    }
    fetch("/admin/ebookslv/apply_defaults", {method: "POST", headers: headers})
      .then(function(response){
        return response.json().catch(function(){ return {}; }).then(function(data){
          if(!response.ok){
            var message = data && data.error ? data.error : "HTTP " + response.status;
            throw new Error(message);
          }
          return data;
        });
      })
      .then(function(){
        setStatus(strings.applySuccess, "success");
      })
      .catch(function(err){
        var message = err && err.message ? err.message : err;
        setStatus(formatMessage(strings.applyFailure, {reason: message}), "error");
      })
      .finally(function(){
        applyBtn.disabled = false;
      });
  });
})();
</script>
{% endblock %}
