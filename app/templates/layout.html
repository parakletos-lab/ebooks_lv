{% extends "calibre-web/cps/templates/layout.html" %}

{% block header %}
  {{ super() }}
  <style id="ub-lang-style">
    .ub-lang-switch { display: flex; align-items: center; height: 50px; gap: 12px; padding: 0 6px; }
    .ub-lang-option { background: transparent; border: none; padding: 0 6px 6px; margin: 0; font-size: 15px; font-weight: 700; letter-spacing: 0.5px; line-height: 20px; color: inherit; text-transform: uppercase; }
    .ub-lang-option.active { color: var(--cw-primary, #0f6958); border-bottom: 2px solid currentColor; }
    .ub-lang-option:focus { outline: none; box-shadow: none; }
    .ub-profile-disabled { pointer-events: none; cursor: default; color: #777; }
  </style>
{% endblock %}

{% block js %}
  {{ super() }}
  <div id="ub-config"
       data-is-admin="{{ 1 if current_user and current_user.role_admin() else 0 }}"
      data-is-anon="{{ 1 if current_user.is_anonymous else 0 }}"
       data-switch-url="{{ url_for('language_switch.switch_language') }}"
      data-active-lang="{{ session.get('ub_preferred_locale') or (current_user.locale if current_user and (not current_user.is_anonymous) else None) or 'lv' }}"
      data-login-url="{{ url_for('web.login', next=(request.path + '?' + request.query_string.decode('utf-8')).rstrip('?')) }}"
      data-login-label="{{ _('Login') }}"
       hidden></div>
  <script src="{{ url_for('_app_templates.static', filename='js/ub_lang_switch.js') }}"></script>
  <script>
    (function() {
      'use strict';
      var cfg = document.getElementById('ub-config');
      if (!cfg || Number(cfg.dataset.isAdmin || 0) !== 1) {
        return;
      }
      function resolveBookId() {
        var match = window.location.pathname && window.location.pathname.match(/^\/book\/(\d+)/);
        if (match) {
          return match[1];
        }
        var editLink = document.getElementById('edit_book');
        if (editLink && editLink.getAttribute('href')) {
          var hrefMatch = editLink.getAttribute('href').match(/(\d+)/);
          if (hrefMatch) {
            return hrefMatch[1];
          }
        } else {
          // Fallback if detail JS hasn't loaded yet
        }
      }

      function setBusy(state) {
        busy = state;
        buttons.forEach(function(btn) {
          btn.disabled = state;
          btn.classList.toggle('is-busy', state);
          var label = btn.querySelector('.ub-mz-label');
          if (label) {
            label.textContent = state ? syncingLabel : syncLabel;
          }
          insertToolbarButton();
      }

      async function syncMozello() {
        if (busy) {
          return;
        }
        if (!bookId) {
          bookId = resolveBookId();
          if (!bookId) {
            return;
          }
        }
        setBusy(true);
        try {
          var resp = await fetch('/admin/ebookslv/books/api/export_one/' + bookId, { method: 'POST' });
          var data = await resp.json().catch(function() { return null; });
          if (!resp.ok) {
            var reason = data && data.message ? data.message : resp.statusText;
            throw new Error(reason || '');
          }
          flash('success', successMsg);
        } catch (err) {
          var msg = failureMsg;
          if (err && err.message) {
            msg += ' ' + err.message;
          }
          flash('danger', msg);
        } finally {
          setBusy(false);
        }
      }

      function createButton(id) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-warning btn-sm ub-sync-to-mozello';
        btn.id = id;
        btn.innerHTML = '<span class="glyphicon glyphicon-flash" aria-hidden="true"></span><span class="ub-mz-label">' + syncLabel + '</span>';
        btn.addEventListener('click', syncMozello);
        buttons.push(btn);
        return btn;
      }

      function insertToolbarButton() {
        var editBtn = document.getElementById('edit_book');
        if (!editBtn || !editBtn.parentNode) {
          return;
        }
        if (document.getElementById('ub-sync-to-mozello-detail')) {
          return;
        }
        var btn = createButton('ub-sync-to-mozello-detail');
        editBtn.parentNode.appendChild(btn);
      }

      function insertHeaderButton() {
        var header = document.querySelector('#bookDetailsModal .modal-header');
        if (!header || header.querySelector('#ub-sync-to-mozello-header')) {
          return;
        }
        var slot = header.querySelector('.ub-sync-to-mozello-slot');
        if (!slot) {
          slot = document.createElement('div');
          slot.className = 'ub-sync-to-mozello-slot';
          header.appendChild(slot);
        }
        var btn = createButton('ub-sync-to-mozello-header');
        slot.appendChild(btn);
      }

      document.addEventListener('DOMContentLoaded', function() {
        insertToolbarButton();
        insertHeaderButton();
      });

      if (window.jQuery && typeof window.jQuery === 'function' && window.jQuery.fn && window.jQuery.fn.modal) {
        window.jQuery('#bookDetailsModal').on('shown.bs.modal', function(evt) {
          var target = evt && evt.relatedTarget;
          var href = target && target.getAttribute && target.getAttribute('href');
          var match = href && href.match(/\/book\/(\d+)/);
          if (match) {
            bookId = match[1];
          } else {
            bookId = resolveBookId();
          }
          insertHeaderButton();
        });
      }
    })();
  </script>
{% endblock %}
