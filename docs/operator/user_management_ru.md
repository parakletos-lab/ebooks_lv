# Управление пользователями

Это упрощённая инструкция для ежедневной поддержки пользователей **ebooks.lv**.

В основном вы будете использовать админ‑страницу **Mozello Заказы**:

- **Страница заказов**: [/admin/ebookslv/orders/](/admin/ebookslv/orders/)

---

## 1) Что можно делать на странице заказов

Со **Страницы заказов** можно:

- Импортировать оплаченные заказы из Mozello (чтобы выдать доступ)
- Добавлять запись заказа вручную (чтобы выдать доступ)
- Создавать или привязывать пользователя Calibre к клиенту
- Обновлять запись заказа (проверка связей книга/пользователь)
- Удалять запись заказа (отзывает доступ в ebooks.lv; **не** изменяет Mozello)

---

## 2) Частые задачи

### 2.1 Клиент купил книгу, но не видит её

1. Откройте **Страницу заказов** [/admin/ebookslv/orders/](/admin/ebookslv/orders/).
2. Нажмите **Импортировать оплаченные заказы Mozello**.
   - Используйте диапазон дат (по умолчанию последние ~10 дней).
3. Найдите строку клиента по **Email**.
4. Если **Книга Calibre отсутствует** красным, нажмите **Обновить**.
5. Если **Пользователь Calibre не привязан**, нажмите **Создать пользователя**.
   - Если пользователь уже существует, система его привяжет.

Результат:
- В строке должны быть зелёные **Книга Calibre** и **Пользователь Calibre**.

### 2.2 Выдать доступ вручную (создать связь пользователь ↔ книга)

Используйте это, если клиент оплатил, но webhook/импорт не сработал или нужны ручные исправления.

1. Откройте **Страницу заказов** [/admin/ebookslv/orders/](/admin/ebookslv/orders/).
2. В форме **Добавить заказ**:
   - Введите **Email** клиента.
   - Введите **Mozello идентификатор** купленной книги (обычно `book-123`).
3. Нажмите **Добавить заказ**.
4. Если под **Пользователь Calibre** написано “Не привязан”, нажмите **Создать пользователя**.
5. Если под **Книга Calibre** написано “Книга Calibre отсутствует”, нажмите **Обновить**.

Примечание:
- Если не знаете идентификатор, откройте [/admin/ebookslv/books/](/admin/ebookslv/books/) и найдите книгу/handle в таблице.

### 2.3 Клиент не может войти / забыл пароль

- Попросите клиента использовать кнопку **Забыли пароль?** на странице [/login](/login).
- Если отправка почты настроена, клиент получит письмо для сброса пароля.

Если сброс не работает:
- Проверьте корректность email в записи заказа.
- При необходимости нажмите **Создать пользователя**, чтобы убедиться, что аккаунт существует.

#### Правила пароля (важно для «сгенерированных браузером» паролей)

Если браузерный пароль отклоняется, причина — настройки **Политики пароля пользователя** (User Password policy) в Calibre-Web.

Где настроить:
- [/admin/config](/admin/config) → **Редактировать базовую конфигурацию** → секция **Политика пароля пользователя**.

Настройки, влияющие на проверку:
- **Политика пароля пользователя** (вкл/выкл)
- **Минимальная длина пароля** (`config_password_min_length`)
- **Требование цифр** (`config_password_number`)
- **Требование маленьких букв** (`config_password_lower`)
- **Требование больших букв** (`config_password_upper`)
- **Требование специальных символов** (`config_password_special`)

Рекомендуемые настройки для стандартных паролей браузера:
- **Политика пароля пользователя = ВКЛ**
- **Минимальная длина = 12** (или `10` при необходимости)
- Включить требования: цифры / маленькие / большие буквы
- Отключить требование специальных символов

Если нужно «принимать всё без сюрпризов»:
- **Политика пароля пользователя = ВЫКЛ**

### 2.4 Отозвать доступ (удалить купленную книгу у пользователя)

1. Откройте **Страницу заказов** [/admin/ebookslv/orders/](/admin/ebookslv/orders/).
2. Найдите нужную запись заказа.
3. Нажмите значок корзины (**Удалить**) и подтвердите.

Важно:
- Удаляется только **локальная запись доступа**.
- Mozello данные не изменяются и возврат не происходит.

### 2.5 Убрать дубликаты / исправить неверный email

- Если запись заказа создана с неверным email или идентификатором — **Удалить** и создать правильную.
- Если есть несколько дубликатов для одного пользователя и идентификатора — удалите лишние.

---

## 3) Быстрое устранение проблем

### 3.1 Книга Calibre отсутствует

Частые причины:
- Mozello идентификатор не совпадает ни с одной выгруженной книгой.
- Книга есть в Mozello, но не была экспортирована через Books Sync.

Решение:
- Перейдите в [/admin/ebookslv/books/](/admin/ebookslv/books/) и экспортируйте/синхронизируйте книгу.
- Вернитесь на **Страницу заказов** и нажмите **Обновить**.

### 3.2 Создать пользователя не работает

Частые причины:
- В данный момент недоступен Calibre runtime.

Решение:
- Попробуйте позже.
- Если пользователь уже существует, нажмите **Обновить** и затем снова **Создать пользователя** — произойдёт привязка существующего аккаунта.

---
